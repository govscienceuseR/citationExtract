---
title: "sgma"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sgma}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_knit$set(root.dir = '~/Box/citation_classifier/')
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, results = F, warning = F, message = F}
packs = c('data.table','pdftools','pbapply','stringr', 'jsonlite', 
          'purrr', 'magrittr', 'dplyr', 'tidyr', 'tools')
sapply(packs, require, character.only = T)
library(citationExtract)
```

Let's take a look at PDFs we have downloaded: the GSPs for California's SGMA.

```{r}
list.files("~/Box/citation_classifier/documents_gsp/")
```

We will take these files and walk through the first three steps of the citationExtract package: extracting with `citation_extract`, compiling with `citation_compile` and cleaning with `citation_clean`.

The function below reads in every PDF in the 'documents_gsp/' folder and runs them through the Anystyle API, to extract probable citations as JSON files into the 'reference_extracts_gsp' folder. We specify no layout...

```{r, eval = F}
citation_extract(doc_dir = '~/Box/citation_classifier/documents_gsp/', 
                 ref_dir = '~/Box/citation_classifier/reference_extracts_gsp', 
                 layout = "none")
```

Now we have the citation JSONS.
```{r}
list.files('~/Box/citation_classifier/reference_extracts_gsp')
```

Next we will transform those JSONs to tabular data and compile them all into one data frame, keeping the file name as an identifier.

```{r, eval = F, warning = F}
dt <- citation_compile('~/Box/citation_classifier/reference_extracts_gsp')
```

```{r, echo = F}
# Output from when citation_compile runs
dt <- readRDS("~/Box/citation_classifier/data/gsp_references.RDS")
```

The output from Anystyle is a bit messy. EXPLAIN WHY.

```{r}
DT::datatable(head(dt, n = 50))
```

So we use the clean function


```{r, echo = F}
# Output from when citation_compile runs
dt <- fread("~/Box/citation_classifier/data/gsp_references.csv")
```

```{r,eval = F}
cleaned_dt <- citation_clean(dt)
```


